local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local character = nil
local anchoredParts = {}
local isAnchoredMode = false
local SPEED_MULTIPLIER = 16
local BASE_STEP = 0.02
local ASCENT_SPEED = 0.15
local DESCENT_SPEED = 0.15
local isJumping = false
local isDescending = false

-- Создаем интерфейс (перенесено до инициализации персонажа)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AnchoredMovementUI"
screenGui.ResetOnSpawn = false -- Важно: GUI не будет пропадать после смерти
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 100)
frame.Position = UDim2.new(0.5, -100, 0, 10)
frame.AnchorPoint = Vector2.new(0.5, 0)
frame.BackgroundTransparency = 0.7
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.Active = true
frame.Draggable = true
frame.Selectable = true
frame.Parent = screenGui

local dragHandle = Instance.new("TextLabel")
dragHandle.Text = "GitHub: NellyStart (Press X for use)"
dragHandle.Size = UDim2.new(1, 0, 0, 20)
dragHandle.TextColor3 = Color3.new(1, 1, 1)
dragHandle.BackgroundTransparency = 0.5
dragHandle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
dragHandle.Parent = frame

local speedLabel = Instance.new("TextLabel")
speedLabel.Text = "Speed Multiplier: "..SPEED_MULTIPLIER
speedLabel.Size = UDim2.new(1, 0, 0, 20)
speedLabel.Position = UDim2.new(0, 0, 0, 25)
speedLabel.TextColor3 = Color3.new(1, 1, 1)
speedLabel.BackgroundTransparency = 1
speedLabel.Name = "SpeedLabel"
speedLabel.Parent = frame

local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(0.6, 0, 0, 25)
textBox.Position = UDim2.new(0.2, 0, 0, 50)
textBox.PlaceholderText = "Enter speed"
textBox.Text = tostring(SPEED_MULTIPLIER)
textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
textBox.TextColor3 = Color3.new(1, 1, 1)
textBox.Parent = frame

local function updateSpeedDisplay()
    speedLabel.Text = "Speed Multiplier: "..SPEED_MULTIPLIER
    textBox.Text = tostring(SPEED_MULTIPLIER)
end

textBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        local newSpeed = tonumber(textBox.Text)
        if newSpeed and newSpeed > 0 then
            SPEED_MULTIPLIER = newSpeed
            updateSpeedDisplay()
            print("Speed changed to:", SPEED_MULTIPLIER)
        else
            textBox.Text = tostring(SPEED_MULTIPLIER)
        end
    end
end)

local function getCharacterParts()
    local parts = {}
    if character then
        for _, child in ipairs(character:GetDescendants()) do
            if child:IsA("BasePart") then
                table.insert(parts, child)
            end
        end
    end
    return parts
end

local function toggleAnchoredMode()
    if not character then return end
    
    isAnchoredMode = not isAnchoredMode
    anchoredParts = getCharacterParts()
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChildWhichIsA("BasePart")
    if not rootPart then return end
    
    local rootCFrame = rootPart.CFrame
    local partsRelative = {}
    
    for _, part in ipairs(anchoredParts) do
        partsRelative[part] = rootCFrame:PointToObjectSpace(part.Position)
    end
    
    for part, relativePos in pairs(partsRelative) do
        part.Anchored = isAnchoredMode
        part.Velocity = Vector3.new()
        part.RotVelocity = Vector3.new()
        
        if isAnchoredMode then
            part.CFrame = rootCFrame * CFrame.new(relativePos)
        end
    end
    
    print(string.format("Anchored mode: %s | Speed: %d (Step: %.3f)", 
        isAnchoredMode, SPEED_MULTIPLIER, BASE_STEP * SPEED_MULTIPLIER))
end

local function updateMovement(dt)
    if not isAnchoredMode or not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChildWhichIsA("BasePart")
    if not rootPart then return end
    
    local rootPos = rootPart.Position
    local partsRelative = {}
    for _, part in ipairs(anchoredParts) do
        partsRelative[part] = part.Position - rootPos
    end
    
    local moveVector = Vector3.new()
    
    -- Горизонтальное движение (R6 совместимость)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        local moveDirection = humanoid.MoveDirection
        if moveDirection.Magnitude > 0 then
            moveVector = moveVector + (moveDirection.Unit * BASE_STEP * SPEED_MULTIPLIER)
        end
    end
    
    -- Вертикальное движение
    if isJumping then
        moveVector = moveVector + Vector3.new(0, ASCENT_SPEED, 0)
    end
    
    if isDescending then
        moveVector = moveVector + Vector3.new(0, -DESCENT_SPEED, 0)
    end
    
    if moveVector.Magnitude > 0 then
        local newRootPos = rootPos + moveVector
        rootPart.CFrame = CFrame.new(newRootPos, newRootPos + moveVector)
        
        for part, relativePos in pairs(partsRelative) do
            part.CFrame = CFrame.new(newRootPos + relativePos)
        end
    end
end

-- Обработчики ввода (изменено на X)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed then
        if input.KeyCode == Enum.KeyCode.X then
            toggleAnchoredMode()
        elseif input.KeyCode == Enum.KeyCode.Space then
            isJumping = true
        elseif input.KeyCode == Enum.KeyCode.Q then
            isDescending = true
        end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Space then
        isJumping = false
    elseif input.KeyCode == Enum.KeyCode.Q then
        isDescending = false
    end
end)

-- Обработчик смены персонажа
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    if isAnchoredMode then
        anchoredParts = getCharacterParts()
        for _, part in ipairs(anchoredParts) do
            part.Anchored = true
            part.Velocity = Vector3.new()
            part.RotVelocity = Vector3.new()
        end
    end
end)

-- Инициализация персонажа
if player.Character then
    character = player.Character
end

RunService.Heartbeat:Connect(updateMovement)
updateSpeedDisplay()
print("Script loaded! Controls: X - toggle mode, Space - ascend, Q - descend")

--Send Notification
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

-- Создаем функцию для отображения оповещения
local function sendNotification()
    local message = "FE LagSwitch"
    
    -- Отправляем уведомление всем игрокам
    StarterGui:SetCore("SendNotification", {
        Title = "Press X",
        Text = message,
        Duration = 6 -- Продолжительность уведомления в секундах
    })
end

-- Вызываем функцию
